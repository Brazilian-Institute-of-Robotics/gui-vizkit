#! /usr/bin/env ruby

require 'vizkit'
require 'orocos'
require 'optparse'
require 'rock/bundle'

@show_all = false
@proxy = true
parser = OptionParser.new do |opt|
    opt.banner = "rock-display [--host hostname] task_name[:port_name] [task_name[:port_name]]"
    opt.on('--host=HOSTNAME', String, "the corba nameserver we should contact") do |name|
        Orocos::CORBA.name_service = name
    end
    opt.on('-a','--all',"Display all tasks") do
        @show_all = true
    end
    opt.on('--noproxy',"Do not use a port proxy between the task inspector and other orocos tasks") do
        @proxy = false
    end
    opt.on('--debug',"Show debug information") do
        Vizkit.logger.level = Logger::INFO
    end
    opt.on('--help') do
        puts parser
        exit 0
    end
end


remaining = parser.parse(ARGV)
task_inspector = nil

Bundles.public_logs = false
Bundles.initialize
Vizkit::ReaderWriterProxy.default_policy[:port_proxy] = nil if !@proxy

if remaining.empty?
  @timer = Qt::Timer.new
  task_inspector ||= Vizkit.default_loader.task_inspector
  task_inspector.enable_tooling=@show_all

  #check for new tasks every 5 seconds 
  refresh = Proc.new do 
      begin
      Orocos.task_names.each do |name|
          task_inspector.config(name)
      end
      rescue Orocos::CORBAError => e
          Vizkit.warn "Corba error. Maybe Orocos is not initialized."
          Vizkit.warn e
          Vizkit.warn e.backtrace
      end
  end
  @timer.connect SIGNAL('timeout()') do 
      refresh.call
  end
  refresh.call
  @timer.start(5000)
else
    remaining.each do |spec|
        task_name, port_name = spec.split(':')
        task = Vizkit::TaskProxy.new task_name
        if !port_name || !task.ping
            task_inspector ||= Vizkit.default_loader.task_inspector
            task_inspector.config(task)
        else
            widget = Vizkit.default_loader.widget_for task.port(port_name)
            if widget
                Vizkit.connect_port_to task_name,port_name,widget
                widget.show
            else
                Vizkit.warn "Cannot find a display widget for #{port_name}"
            end
        end
    end
    task_inspector.force_update = true if task_inspector
end

if task_inspector
    task_inspector.show
else
    puts parser
    exit 1
end
Vizkit.exec

